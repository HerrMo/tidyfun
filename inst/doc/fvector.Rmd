---
title: "<ftable> and <fvector> - new data structures for tidy functional data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Definition: `fvector`

`fvector` is a new `S3` class for representing functional data. 

Internallly, an `fvector` is 

- a list of (something like) function values 
- with attributes for metainformation like ranges or bases

so that functional data can be included in tidy `data.frames` as list columns^[similar in construction to the `sfc`-columns  that `sf` defines].

We'll have at least 3 subclasses for different data settings:

- functional data as function evaluations: `feval`
    - on a common grid of argument values: `feval_reg`
    - on observation-specific grids of argument values: `feval_irreg`
- functional data in basis function representation: `fbasis`

## Sandbox

```{r sandbox}
devtools::load_all(".")
n <- 5
grid <-  seq(0, 1, l = 11)
mat_reg <- t(replicate(n, dbeta(grid, runif(1, 2, 7), runif(1, 3, 12))))
colnames(mat_reg) <- grid
mat_irreg <- mat_reg; mat_irreg[sample(1:length(mat_reg), length(mat_reg)/3)] <- NA

f_reg <- feval(mat_reg)
str(f_reg, 1)
str(argvals(f_reg), 1)

f_irreg <- feval(mat_irreg)
str(f_irreg, 1)
str(argvals(f_irreg), 1)

as.data.frame(f_reg)
as.data.frame(f_irreg)
all.equal(as.feval(as.data.frame(f_reg)), f_reg)
all.equal(as.feval(as.data.frame(f_irreg)), f_irreg)
testthat::expect_equivalent(as.matrix(f_reg), mat_reg)
testthat::expect_equivalent(as.matrix(f_irreg), mat_irreg)
```

*TODO: validation methods*
*TODO: converters for fdata, fd*
*TODO: multivariate functions, multidimensional argvals*

```{r feval-methods, eval = FALSE}
#summary #define Arith-methods first.... 
# c.feval_reg #???
`[.feval` <- function(x, i, j, interpolate = TRUE) {
  browser()
  if (missing(j)) {
    ret <- unclass(x)[i]
    domain(ret) <- domain(x); range(ret) <- range(x); class(ret) <- class(x)
    return(ret)
  }
  if (!interpolate) {
    in_argvals <- map2(list(j), argvals(x), ~ which(.x %in% .y))
    if(any(!in_argvals)) warning("<j> not part of argvals")
  }
  # check j in range  
  }
}
#`[.feval_irreg`
#`[<-`  
#plot
#length
#deriv
#mean
#quantile
#var
#sd
#cov
#cor
#max
#min

# new generics:
integrate

```
